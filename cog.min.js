/*! Cog.js v1.3.0pre | (c) 2013-2014 Michael Good | MIT license. */
(function(){var a=this,b=Object.prototype.hasOwnProperty,c=Array.prototype.slice,d=Object.prototype.toString,e=function(){return this instanceof e?this:new e};e.VERSION="1.3.0pre";function f(){var a,b,c,d,e,g,h=arguments[0]||{},j=1,k=arguments.length,m=!1;for("boolean"==typeof h&&(m=h,h=arguments[j]||{},j++),"object"==typeof h||l(h)||(h={});k>j;++j)if(null!=(a=arguments[j]))for(b in a)c=h[b],d=a[b],h!==d&&(m&&d&&(o(d)||(e=i(d)))?(e?(e=!1,g=c&&i(c)?c:[]):g=c&&o(c)?c:{},h[b]=f(m,g,d)):void 0!==d&&(h[b]=d));return h}function g(a){return c.call(arguments,1).forEach(function(b){if(b)for(var c in b)void 0===a[c]&&(a[c]=b[c])}),a}function h(a){return null==a?a+"":"object"==typeof a||"function"==typeof a?"object":typeof a}function i(a){return"[object Array]"===d.call(a)}function j(a){return"[object Date]"===d.call(a)}function k(a){return a===!0||a===!1||"[object Boolean]"==d.call(a)}function l(a){return"function"==typeof a}function m(a){return"[object Number]"===d.call(a)}function n(a){return a===Object(a)}function o(a){if("object"!==h(a)||a.nodeType||r(a))return!1;try{if(a.constructor&&!b.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(c){return!1}return!0}function p(a){return"[object RegExp]"===d.call(a)}function q(a){return"[object String]"===d.call(a)}function r(a){return null!=a&&a===a.window}var s=!1,t=/xyz/.test(function(){})?/\b_super\b/:/.*/;function u(a,b,c){for(var d in c)a[d]=l(c[d])&&l(b[d])&&t.test(c[d])?function(a,c){return function(){var d=this._super;this._super=b[a];var e=c.apply(this,arguments);return this._super=d,e}}(d,c[d]):c[d]}function v(a,b,c){var d="_"+b;a[d]=c,Object.defineProperty(a,b,{get:function(){return this[d]},set:function(a){var c=this[d];this[d]=a,this.dirty=!0,l(this.trigger)&&this.trigger(b,a,c)},enumerable:!0,configurable:!0})}function w(a,b,c){var d;for(d in b)b.hasOwnProperty(d)&&(c?v(a,d,b[d]):Object.defineProperty(a,d,{value:b[d],configurable:!0,writable:!0,enumerable:!0}))}var x=function(){return arguments.length?x.extend.apply(x,arguments):this};x.create=function(){var a=c.call(arguments);return a.splice(0,0,this),new(Function.prototype.bind.apply(this,a))},x.prototype.destroy=function(){},x.extend=function(a,b,c){var d,e;q(a)||(c=b,b=a,a=null),c||(c=b,b=null),c=c||{},b=b||{},s=!0,d=new this,e=this.prototype,s=!1,u(d,e,c);function f(){if(!(this instanceof f))throw"Constructor called without new keyword";!s&&this.init&&this.init.apply(this,arguments)}return f.prototype=d,f.prototype.constructor=f,u(f,{},e.constructor),u(f,e.constructor,b),Object.defineProperty(f,"fullName",{value:a,writable:!1,configurable:!0,enumerable:!1}),f.dirtyOnChange&&Object.defineProperty(f.prototype,"dirty",{value:!0,writable:!0,configurable:!0,enumerable:!1}),c.defaults&&w(f.prototype,c.defaults,f.dirtyOnChange),c.properties&&Object.defineProperties(f.prototype,c.properties),f.defaults&&w(f,f.defaults,!1),f.properties&&Object.defineProperties(f,f.properties),f.setup&&f.setup(),f},f(e,{extend:f,defaults:g,type:h,isArray:i,isBoolean:k,isDate:j,isFunction:l,isNumber:m,isObject:n,isPlainObject:o,isRegExp:p,isString:q,Construct:x});var y=e.Construct.extend("cog.ArrayWrapper",{init:function(a,b){if(!this.get){var c;c=a instanceof y?a.serialize():e.isArray(a)?a.slice(0):new Array(e.isNumber(a)?a:0),b||(this.add=function(a){return c.push(a),this},this.insert=function(a,b){return c.splice(b,0,a),this},this.remove=function(a){var b=c.indexOf(a);return b>-1&&c.splice(b,1),this},this.removeAtIndex=function(a){return c.splice(a,1),this},this.removeAll=function(){return c.length=0,this},this.removeLast=function(){return c.pop(),this}),this.get=function(a){return c[a]},this.each=function(a){for(var b=0,d=c.length;d>b;++b)a(c[b],b);return this},this.length=function(){return c.length},this.serialize=function(){return c.slice(0)},this.clone=function(){return new y(this,b)},this.readyOnly=function(){return new y(this,!0)}}}}),z=e.Construct.extend("cog.SetWrapper",{init:function(a,b){if(!this.get){var d;d=a instanceof z?a.serialize():e.isObject(a)?e.extend({},a):{},b||(this.set=function(a,b){return d[a]=b,this},this.remove=function(a){for(var b in d)if(d.hasOwnProperty(b)&&d[b]===a)return this.removeKey(b);return this},this.removeKey=function(a){return delete d[a],this},this.removeAll=function(){for(var a in d)d.hasOwnProperty(a)&&delete d[a];return this},this.extend=function(){var a=c.call(arguments);return a.splice(0,0,d),e.extend.apply(e.extend,a),this}),this.get=function(a){return d[a]},this.each=function(a){for(var b in d)d.hasOwnProperty(b)&&a(d[b],b);return this},this.count=function(){var a=0;for(var b in d)d.hasOwnProperty(b)&&++a;return a},this.serialize=function(){return e.extend({},d)},this.clone=function(){return new z(this,b)},this.readOnly=function(){return new z(this,!0)}}}});e.extend(e,{ArrayWrapper:y,SetWrapper:z});function A(){for(var a,b=0,c=0,d=arguments.length;d>c;++c)(a=arguments[c])&&a.category&&(b|=a.category);return b}var B=e.Construct.extend("cog.Entity",{properties:{manager:{get:function(){return this._manager}},id:{get:function(){return this._id}},tag:{get:function(){return this._tag}},valid:{get:function(){return this._manager&&this._id?!0:!1}},mask:{get:function(){return this._componentMask}},parent:{get:function(){return this._parent}},children:{get:function(){return this._children.slice(0)}}},init:function(a,b,c){this._manager=a,this._id=b,this._tag=c||null,this._components={},this._componentMask=0,this._parent=null,this._children=[]},destroy:function(a){return this._manager&&!a?(this._manager.remove(this),void 0):(this.removeAll(),this._manager=void 0,this._id=void 0,this._tag=void 0,this._children=void 0,void 0)},clone:function(){var a,b,c=this._manager.add(this._tag);for(a in this._components)this._components.hasOwnProperty(a)&&(b=this._components[a],c.add(b.constructor,b.serialize()));return c},add:function(a,b){if(!a||!a.category)return void 0;var c,d=a.category;if((d&this._componentMask)===d)c=this._components[d],c.set(b);else{c=this._components[d]=new a(this,b),this._componentMask|=d;var e=a.fullName?a.fullName+" added":"component added";this._manager.director.events.emit(e,c,this)}return c},has:function(a){var b=A.apply(A,arguments);return 0!==b&&(b&this._componentMask)===b},get:function(a){if(!a||!a.category)return void 0;var b=a.category;return this._components[b]},remove:function(a){a instanceof e.Component&&(a=a.constructor);var b,c=a.category;if((c&this._componentMask)===c){b=this._components[c],this._componentMask&=~c,this._components[c]=void 0;var d=a.fullName?a.fullName+" removed":"component removed";this._manager.director.events.emit(d,b,this),b.destroy(!0)}return this},removeAll:function(){var a;for(a in this._components)this._components.hasOwnProperty(a)&&this.remove(this._components[a]);return this},addChild:function(a){return a.parent&&a.parent.removeChild(a),a._parent=this,this._children.push(a),this._manager.director.events.emit("entity addChild",this,a),this},removeChild:function(a){var b;return a.parent===this&&(a._parent=null,b=this._children.indexOf(a),b>-1&&(this._children.splice(b,1),this._manager.director.events.emit("entity removeChild",this,a))),this},removeAllChildren:function(){for(var a=this._children,b=a.length-1;b>=0;--b)this.removeChild(a[b]);return this}});e.extend(e,{Entity:B});function C(a,b,c){if(a>b)throw c}var D=0,E=e.Construct.extend("cog.Component",{properties:{category:{get:function(){return this._category}},count:{get:function(){return D-1}}},setup:function(){C(D,64,"Exceeded 64 Component types."),this._category=0===D?0:1<<D-1,D++}},{properties:{entity:{get:function(){return this._entity}},valid:{get:function(){return void 0!==this._entity}}},init:function(a,b){this._entity=a,this._listeners={},this.set(b)},set:function(a){for(var b in a)a.hasOwnProperty(b)&&this.prop(b,a[b])},prop:function(a,b){if(2===arguments.length){var c=this[a];return this[a]=b,this.trigger(a,b,c),void 0}return this[a]},on:function(a,b){var c=this._listeners[a];c||(c=this._listeners[a]=[]),c.push(b)},off:function(a){if(a)this._listeners[a]&&(this._listeners[a].length=0);else for(a in this._listeners)this._listeners.hasOwnProperty(a)&&(this._listeners[a].length=0)},trigger:function(a,b,c){var d,e,f=this._listeners[a];if(f)for(d=0,e=f.length;e>d;++d)f[d](b,c)},keys:function(){var a,b=[];for(a in this.defaults)this.defaults.hasOwnProperty(a)&&b.push(a);for(a in this.properties)if(this.properties.hasOwnProperty(a)){if("entity"===a||"valid"===a)continue;if(b.indexOf(a)>-1)continue;b.push(a)}return b},serialize:function(){var a,b={};for(a in this.defaults)this.defaults.hasOwnProperty(a)&&(b[a]=this[a]);for(a in this.properties)if(this.properties.hasOwnProperty(a)){if("entity"===a||"valid"===a)continue;b[a]=this[a]}return b},destroy:function(a){return!a&&this._entity&&this._entity.remove?(this._entity.remove(this),void 0):(this.off(),this._entity=void 0,void 0)}});e.extend(e,{Component:E});var F=0,G=e.Construct.extend("cog.System",{properties:{systemId:{get:function(){return this._systemId}},count:{get:function(){return F-1}}},setup:function(){this._systemId=F-1,F++}},{properties:{manager:{get:function(){return this._manager}}},init:function(a){this._manager=a},destroy:function(a){return this._manager&&!a?(this._manager.remove(this),void 0):(this._manager=void 0,void 0)},configure:function(a,b,c){},update:function(a,b,c){},render:function(a){}});e.extend(e,{System:G});var H=e.System.extend("cog.Factory",{entityTag:null,components:{},init:function(a){if(this._entityManager=a.director.entities,this._super(a),this._entities=[],e.isString(this.entityTag)){var b=this;this["spawn "+this.entityTag+" event"]=function(){b.spawn.apply(b,arguments)}}},spawn:function(a){var b,c=this._entityManager.add(this.entityTag),d=this.components,f,g;for(b in d)d.hasOwnProperty(b)&&(f=d[b],g=a&&a[b]?a[b]:{},e.defaults(g,f.defaults),c.add(f.constructor,g));return this._entities.push(c),c},despawn:function(a){var b=this._entities.indexOf(a);b>-1&&(this._entities.splice(b,1),a.destroy())}});e.extend(e,{Factory:H});var I=e.Construct.extend("cog.EntityManager",{properties:{director:{get:function(){return this._director}},valid:{get:function(){return void 0!==this._director}}},init:function(a){this._director=a,this._entities=[],this._entityId=1},destroy:function(){this.removeAll(),this._director=void 0},add:function(a){var b=new B(this,this._entityId++,a);return this._entities.push(b),this._director.events.emit("entity added",b),b},all:function(){for(var a=0,b=this._entities.length,c=[];b>a;++a)c.push(this._entities[a]);return c},withTag:function(a){var b,c=0,d=this._entities.length,e=[];if(a)for(;d>c;++c)b=this._entities[c],b.tag===a&&e.push(b);return e},withComponents:function(){for(var a,b=A.apply(A,arguments),c=0,d=this._entities.length,e=[];d>c;++c)a=this._entities[c],(b&a.mask)===b&&e.push(a);return e},remove:function(a){var b=this._entities.indexOf(a);return b>-1&&(this._entities.splice(b,1),this._director.events.emit("entity removed",a),a.destroy(!0)),this},removeAll:function(){for(var a,b=this._entities.length-1;b>-1;--b)a=this._entities.splice(b,1)[0],this._director.events.emit("entity removed",a),a.destroy(!0);return this},removeWithTag:function(a){for(var b,c=this._entities.length-1;c>-1;--c)this._entities[c].tag===a&&(b=this._entities.splice(c,1)[0],this._director.events.emit("entity removed",b),b.destroy(!0));return this},removeWithComponents:function(){for(var a,b=this._entities.length-1,c=A.apply(A,arguments);b>-1;--b)a=this._entities[b],(c&a.mask)===c&&(a=this._entities.splice(b,1)[0],this._director.events.emit("entity removed",a),a.destroy(!0));return this}});e.extend(e,{EntityManager:I});var J=/.* event$/,K=e.Construct.extend("cog.SystemManager",{properties:{director:{get:function(){return this._director}},valid:{get:function(){return void 0!==this._director}}},init:function(a){this._director=a,this._eventContexts={},this._eventCallbacks={}},destroy:function(){this.unregisterAll(),this._director=void 0},emit:function(a){var b,d,e,f=this._eventContexts[a],g=this._eventCallbacks[a];if(f&&g)for(e=c.call(arguments,1),b=0,d=g.length;d>b;++b)g[b].apply(f[b],e);return this},register:function(a,b,c){if(!e.isObject(b)||!e.isFunction(c))return this;var d=this._eventContexts[a],f=this._eventCallbacks[a];return(void 0===d||void 0===f)&&(d=this._eventContexts[a]=[],f=this._eventCallbacks[a]=[]),d.push(b),f.push(c),this},registerContext:function(a){var b,c;for(b in a)(c=a[b])&&e.isFunction(c)&&J.test(b)&&this.register(b.substring(0,b.length-6),a,c);return this},unregister:function(a,b){var c,d=this._eventContexts[a],e=this._eventCallbacks[a];if(d&&e)for(c=d.length-1;c>=0;--c)d[c]===b&&(d.splice(c,1),e.splice(c,1));return this},unregisterContext:function(a){for(var b in this._eventContexts)this._eventContexts.hasOwnProperty(b)&&this.unregister(b,a);return this},unregisterEvent:function(a){var b=this._eventContexts[a],c=this._eventCallbacks[a];return b&&c&&(this._eventContexts[a].length=0,this._eventCallbacks[a].length=0),this},unregisterAll:function(){for(var a in this._eventContexts)this._eventContexts.hasOwnProperty(a)&&this.unregisterEvent(a);return this}});e.extend(e,{EventManager:K});var L=e.Construct.extend("cog.SystemManager",{properties:{director:{get:function(){return this._director}},valid:{get:function(){return void 0!==this._director}}},init:function(a){this._systems={},this._systemOrder=[],this._director=a},destroy:function(){this.removeAll(),this._director=void 0},add:function(a){if(!a||!a.systemId)return void 0;var b=a.systemId,c=this._systems[b];return c||(c=new a(this),this._systems[b]=c,this._systemOrder.push(c),this._director.events.registerContext(c),c.configure(this._director.entities,this._director.events,this._director.config)),c},get:function(a){var b=a.systemId;return this._systems[b]},remove:function(a){var b,c,d;return a instanceof e.System&&(d=a,a=d.constructor),a&&a.systemId?(c=a.systemId,d||(d=this._systems[c]),d&&(b=this._systemOrder.indexOf(d),this._director.events.unregisterContext(d),this._systemOrder.splice(b,1),this._systems[c]=void 0,d.destroy(!0)),this):this},removeAll:function(){var a,b,c;for(b in this._systems)this._systems.hasOwnProperty(b)&&(c=this._systems[b],c&&(a=this._systemOrder.indexOf(c),this._director.events.unregisterContext(c),this._systemOrder.splice(a,1),this._systems[b]=void 0,c.destroy(!0)));return this},update:function(a){for(var b=0,c=this._systemOrder.length,d=this._systemOrder,e=this._director.entities,f=this._director.events;c>b;++b)d[b].update(e,f,a);return this},render:function(){for(var a=0,b=this._systemOrder.length,c=this._systemOrder,d=this._director.entities;b>a;++a)c[a].render(d);return this}});e.extend(e,{SystemManager:L}),function(){for(var a=0,b=["webkit","moz"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var d=(new Date).getTime(),e=Math.max(0,16-(d-a)),f=window.setTimeout(function(){b(d+e)},e);return a=d+e,f}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}();var M=e.Construct.extend("cog.Director",{create:function(a){return new M(a)}},{properties:{config:{get:function(){return this._config}},events:{get:function(){return this._eventManager}},entities:{get:function(){return this._entityManager}},systems:{get:function(){return this._systemManager}},valid:{get:function(){return void 0!==this._entityManager&&void 0!==this._systemManager&&void 0!==this._eventManager}}},init:function(a){this._config=a,this._eventManager=new K(this),this._entityManager=new I(this),this._systemManager=new L(this),this._beginUpdateCallback=null,this._animationFrame=null,this._lastFrame=0},destroy:function(){this.stop(),this._entityManager.destroy(),this._eventManager.destroy(),this._systemManager.destroy(),this._entityManager=void 0,this._systemManager=void 0,this._eventManager=void 0,this._beginUpdateCallback=void 0,this._endUpdateCallback=void 0},start:function(){this._animationFrame||(this._lastFrame=0,this._animationFrame=requestAnimationFrame(this.step.bind(this)))},stop:function(){this._animationFrame&&(cancelAnimationFrame(this._animationFrame),this._animationFrame=null)},step:function(a){var b=this._lastFrame,c=0!==b?a-b:16;this._beginStepCallback&&this._beginStepCallback(),this.update(c),this.render(),this._endStepCallback&&this._endStepCallback(),this._animationFrame&&(this._lastFrame=a,this._animationFrame=requestAnimationFrame(this.step.bind(this)))},update:function(a){this._beginUpdateCallback&&this._beginUpdateCallback(),this._systemManager.update(a),this._endUpdateCallback&&this._endUpdateCallback()},render:function(){this._systemManager.render()},onBeginUpdate:function(a){return this._beginUpdateCallback=a,this},onEndUpdate:function(a){return this._endUpdateCallback=a,this},onBeginStep:function(a){return this._beginStepCallback=a,this},onEndStep:function(a){return this._endStepCallback=a,this}});e.extend(e,{Director:M,createDirector:M.create}),"function"==typeof define&&define.amd&&define("cog",[],function(){return e}),a.cog=e}).call(this);
//# sourceMappingURL=cog.min.map