/*! Cog.js v1.3.1pre | (c) 2013-2014 Michael Good | MIT license. */
(function(){var a=Object.prototype.hasOwnProperty,b=Array.prototype.slice,c=Object.prototype.toString,d=function(){return this instanceof d?this:new d};d.VERSION="1.3.1pre",d.extend=function N(){var a,b,c,d,e,f,h=arguments[0]||{},i=1,k=arguments.length,l=!1;for("boolean"==typeof h&&(l=h,h=arguments[i]||{},i++),"object"==typeof h||j(h)||(h={}),i===k&&(h=this,i--);k>i;++i)if(null!=(a=arguments[i]))for(b in a)c=h[b],d=a[b],h!==d&&(l&&d&&(m(d)||(e=g(d)))?(e?(e=!1,f=c&&g(c)?c:[]):f=c&&m(c)?c:{},h[b]=N(l,f,d)):void 0!==d&&(h[b]=d));return h};function e(a){return b.call(arguments,1).forEach(function(b){if(b)for(var c in b)void 0===a[c]&&(a[c]=b[c])}),a}function f(a){return null==a?a+"":"object"==typeof a||"function"==typeof a?"object":typeof a}function g(a){return"[object Array]"===c.call(a)}function h(a){return"[object Date]"===c.call(a)}function i(a){return a===!0||a===!1||"[object Boolean]"==c.call(a)}function j(a){return"function"==typeof a}function k(a){return"[object Number]"===c.call(a)}function l(a){return a===Object(a)}function m(b){if("object"!==f(b)||b.nodeType||p(b))return!1;try{if(b.constructor&&!a.call(b.constructor.prototype,"isPrototypeOf"))return!1}catch(c){return!1}return!0}function n(a){return"[object RegExp]"===c.call(a)}function o(a){return"[object String]"===c.call(a)}function p(a){return null!=a&&a===a.window}var q=!1,r=/xyz/.test(function(){})?/\b_super\b/:/.*/;function s(a,b,c){for(var d in c)a[d]=j(c[d])&&j(b[d])&&r.test(c[d])?function(a,c){return function(){var d=this._super;this._super=b[a];var e=c.apply(this,arguments);return this._super=d,e}}(d,c[d]):c[d]}function t(a,b,c){var d="_"+b;a[d]=c,Object.defineProperty(a,b,{get:function(){return this[d]},set:function(a){var c=this[d];this[d]=a,this.dirty=!0,j(this.trigger)&&this.trigger(b,a,c)},enumerable:!0,configurable:!0})}function u(a,b,c){var d;for(d in b)b.hasOwnProperty(d)&&(c?t(a,d,b[d]):Object.defineProperty(a,d,{value:b[d],configurable:!0,writable:!0,enumerable:!0}))}var v=function(){return arguments.length?v.extend.apply(v,arguments):this};v.create=function(){var a=b.call(arguments);return a.splice(0,0,this),new(Function.prototype.bind.apply(this,a))},v.prototype.destroy=function(){},v.extend=function(a,b,c){var d,e;o(a)||(c=b,b=a,a=null),c||(c=b,b=null),c=c||{},b=b||{},q=!0,d=new this,e=this.prototype,q=!1,s(d,e,c);function f(){if(!(this instanceof f))throw"Constructor called without new keyword";!q&&this.init&&this.init.apply(this,arguments)}return f.prototype=d,f.prototype.constructor=f,s(f,{},e.constructor),s(f,e.constructor,b),Object.defineProperty(f,"fullName",{value:a,writable:!1,configurable:!0,enumerable:!1}),f.dirtyOnChange&&Object.defineProperty(f.prototype,"dirty",{value:!0,writable:!0,configurable:!0,enumerable:!1}),c.defaults&&u(f.prototype,c.defaults,f.dirtyOnChange),c.properties&&Object.defineProperties(f.prototype,c.properties),f.defaults&&u(f,f.defaults,!1),f.properties&&Object.defineProperties(f,f.properties),f.setup&&f.setup(),f},d.extend({defaults:e,type:f,isArray:g,isBoolean:i,isDate:h,isFunction:j,isNumber:k,isObject:l,isPlainObject:m,isRegExp:n,isString:o,Construct:v});var w={enable:function(){this._enabled=!0},disable:function(){this._enabled=!1},log:function(a){this._enabled&&console.log(a)}};d.extend({debug:w});var x=d.Construct.extend("cog.ArrayWrapper",{init:function(a,b){if(!this.get){var c;c=a instanceof x?a.serialize():d.isArray(a)?a.slice(0):new Array(d.isNumber(a)?a:0),b||(this.add=function(a){return c.push(a),this},this.insert=function(a,b){return c.splice(b,0,a),this},this.remove=function(a){var b=c.indexOf(a);return b>-1&&c.splice(b,1),this},this.removeAtIndex=function(a){return c.splice(a,1),this},this.removeAll=function(){return c.length=0,this},this.removeLast=function(){return c.pop(),this}),this.get=function(a){return c[a]},this.each=function(a){for(var b=0,d=c.length;d>b;++b)a(c[b],b);return this},this.length=function(){return c.length},this.serialize=function(){return c.slice(0)},this.clone=function(){return new x(this,b)},this.readyOnly=function(){return new x(this,!0)}}}}),y=d.Construct.extend("cog.SetWrapper",{init:function(a,c){if(!this.get){var e;e=a instanceof y?a.serialize():d.isObject(a)?d.extend({},a):{},c||(this.set=function(a,b){return e[a]=b,this},this.remove=function(a){for(var b in e)if(e.hasOwnProperty(b)&&e[b]===a)return this.removeKey(b);return this},this.removeKey=function(a){return delete e[a],this},this.removeAll=function(){for(var a in e)e.hasOwnProperty(a)&&delete e[a];return this},this.extend=function(){var a=b.call(arguments);return a.splice(0,0,e),d.extend.apply(d.extend,a),this}),this.get=function(a){return e[a]},this.each=function(a){for(var b in e)e.hasOwnProperty(b)&&a(e[b],b);return this},this.count=function(){var a=0;for(var b in e)e.hasOwnProperty(b)&&++a;return a},this.serialize=function(){return d.extend({},e)},this.clone=function(){return new y(this,c)},this.readOnly=function(){return new y(this,!0)}}}});d.extend({ArrayWrapper:x,SetWrapper:y});var z=function(){var a,b=256,c=6,d=52,e=new Array(b),f=[],g=Math.pow(b,c),h=Math.pow(2,d),i=2*h,j=b-1;function k(a){var b,c=0,d=a+"";for(f.length=0;c<d.length;++c)f[j&c]=j&(b^=19*f[j&c])+d.charCodeAt(c)}function l(){var a,c,d=0,g=f.length;for(c=0;b>c;++c)e[c]=c;for(c=0;b>c;++c)d=(d+e[c]+f[c%g])%b,a=e[c],e[c]=e[d],e[d]=a}var m={i:0,j:0,out:function(a){var c=this.i,d=this.j,f,g=0;while(a--)f=e[c=(c+1)%j],g=g*b+e[j&(e[c]=e[d=j&d+f])+(e[d]=f)];return this.i=c,this.j=d,g}};function n(){var a=m.out(c),d=g,e=0;while(h>a)a=(a+e)*b,d*=b,e=m.out(1);while(a>=i)a/=2,d/=2,e>>>=1;return(a+e)/d}function o(b){return arguments.length>0?(k(b),l(),m.i=0,m.j=0,a=b,void 0):a}function p(){o(Math.random())}function q(){o(Date.now())}function r(){return m.out(1)}function s(a,b){var c=n(),d=arguments.length;return 0===d?c:(1===d&&(b=a,a=0),c*(b-a)+a)}function t(a,b){var c=n(),d=arguments.length;return 0===d?Math.floor(2*c):(1===d&&(b=a,a=0),Math.floor(c*(b-a+1))+a)}return q(),{seed:o,seedRand:p,seedTime:q,arc4rand:s,arc4randInt:t,arc4rand255:r}}();d.extend({rand:z});function A(){for(var a,b=0,c=0,d=arguments.length;d>c;++c)(a=arguments[c])&&a.category&&(b|=a.category);return b}var B=d.Construct.extend("cog.Entity",{properties:{manager:{get:function(){return this._manager}},id:{get:function(){return this._id}},tag:{get:function(){return this._tag}},valid:{get:function(){return this._manager&&this._id?!0:!1}},mask:{get:function(){return this._componentMask}},parent:{get:function(){return this._parent}},children:{get:function(){return this._children.slice(0)}}},init:function(a,b,c){this._manager=a,this._id=b,this._tag=c||null,this._components={},this._componentMask=0,this._parent=null,this._children=[]},destroy:function(a){return this._manager&&!a?(this._manager.remove(this),void 0):(this.removeAll(),this._manager=void 0,this._id=void 0,this._tag=void 0,this._children=void 0,void 0)},clone:function(){var a,b,c=this._manager.add(this._tag);for(a in this._components)this._components.hasOwnProperty(a)&&(b=this._components[a],c.add(b.constructor,b.serialize()));return c},add:function(a,b){if(!a||!a.category)return void 0;var c,d=a.category;if((d&this._componentMask)===d)c=this._components[d],c.set(b);else{c=this._components[d]=new a(this,b),this._componentMask|=d;var e=a.fullName?a.fullName+" added":"component added";this._manager.director.events.emit(e,c,this)}return c},has:function(a){var b=A.apply(A,arguments);return 0!==b&&(b&this._componentMask)===b},get:function(a){if(!a||!a.category)return void 0;var b=a.category;return this._components[b]},all:function(){var a,b,c=[];for(a in this._components)this._components.hasOwnProperty(a)&&(b=this._components[a],c.push(b));return c},remove:function(a){a instanceof d.Component&&(a=a.constructor);var b,c=a.category;if((c&this._componentMask)===c){b=this._components[c],this._componentMask&=~c,this._components[c]=void 0;var e=a.fullName?a.fullName+" removed":"component removed";this._manager.director.events.emit(e,b,this),b.destroy(!0)}return this},removeAll:function(){var a;for(a in this._components)this._components.hasOwnProperty(a)&&this.remove(this._components[a]);return this},addChild:function(a){return a.parent&&a.parent.removeChild(a),a._parent=this,this._children.push(a),this._manager.director.events.emit("entity addChild",this,a),this},removeChild:function(a){var b;return a.parent===this&&(a._parent=null,b=this._children.indexOf(a),b>-1&&(this._children.splice(b,1),this._manager.director.events.emit("entity removeChild",this,a))),this},removeAllChildren:function(){for(var a=this._children,b=a.length-1;b>=0;--b)this.removeChild(a[b]);return this}});d.extend({Entity:B});function C(a,b,c){if(a>b)throw c}var D=0,E=d.Construct.extend("cog.Component",{properties:{category:{get:function(){return this._category}},count:{get:function(){return D-1}}},setup:function(){C(D,64,"Exceeded 64 Component types."),this._category=0===D?0:1<<D-1,D++}},{properties:{entity:{get:function(){return this._entity}},valid:{get:function(){return void 0!==this._entity}}},init:function(a,b){this._entity=a,this._listeners={},this.set(b)},set:function(a){for(var b in a)a.hasOwnProperty(b)&&this.prop(b,a[b])},prop:function(a,b){if(2===arguments.length){var c=this[a];return this[a]=b,this.trigger(a,b,c),void 0}return this[a]},on:function(a,b){var c=this._listeners[a];c||(c=this._listeners[a]=[]),c.push(b)},off:function(a){if(a)this._listeners[a]&&(this._listeners[a].length=0);else for(a in this._listeners)this._listeners.hasOwnProperty(a)&&(this._listeners[a].length=0)},trigger:function(a,b,c){var d,e,f=this._listeners[a];if(f)for(d=0,e=f.length;e>d;++d)f[d](b,c)},keys:function(){var a,b=[];for(a in this.defaults)this.defaults.hasOwnProperty(a)&&b.push(a);for(a in this.properties)if(this.properties.hasOwnProperty(a)){if("entity"===a||"valid"===a)continue;if(b.indexOf(a)>-1)continue;b.push(a)}return b},serialize:function(){var a,b={};for(a in this.defaults)this.defaults.hasOwnProperty(a)&&(b[a]=this[a]);for(a in this.properties)if(this.properties.hasOwnProperty(a)){if("entity"===a||"valid"===a)continue;b[a]=this[a]}return b},destroy:function(a){return!a&&this._entity&&this._entity.remove?(this._entity.remove(this),void 0):(this.off(),this._entity=void 0,void 0)}});d.extend({Component:E});var F=0,G=d.Construct.extend("cog.System",{properties:{systemId:{get:function(){return this._systemId}},count:{get:function(){return F-1}}},setup:function(){this._systemId=F-1,F++}},{properties:{manager:{get:function(){return this._manager}}},init:function(a){this._manager=a},destroy:function(a){return this._manager&&!a?(this._manager.remove(this),void 0):(this._manager=void 0,void 0)},configure:function(a,b,c){},update:function(a,b,c){},render:function(a){}});d.extend({System:G});var H=d.System.extend("cog.Factory",{entityTag:null,components:{},init:function(a){if(this._entityManager=a.director.entities,this._super(a),this._entities=[],d.isString(this.entityTag)){var b=this;this["spawn "+this.entityTag+" event"]=function(){b.spawn.apply(b,arguments)}}},spawn:function(a){var b,c=this._entityManager.add(this.entityTag),e=this.components,f,g;for(b in e)e.hasOwnProperty(b)&&(f=e[b],g=a&&a[b]?a[b]:{},d.defaults(g,f.defaults),c.add(f.constructor,g));return this._entities.push(c),c},despawn:function(a){var b=this._entities.indexOf(a);b>-1&&(this._entities.splice(b,1),a.destroy())}});d.extend({Factory:H});var I=d.Construct.extend("cog.EntityManager",{properties:{director:{get:function(){return this._director}},valid:{get:function(){return void 0!==this._director}}},init:function(a){this._director=a,this._entities=[],this._entityId=1},destroy:function(){this.removeAll(),this._director=void 0},add:function(a){var b=new B(this,this._entityId++,a);return this._entities.push(b),this._director.events.emit("entity added",b),b},all:function(){for(var a=0,b=this._entities.length,c=[];b>a;++a)c.push(this._entities[a]);return c},withTag:function(a){var b,c=0,d=this._entities.length,e=[];if(a)for(;d>c;++c)b=this._entities[c],b.tag===a&&e.push(b);return e},withComponents:function(){for(var a,b=A.apply(A,arguments),c=0,d=this._entities.length,e=[];d>c;++c)a=this._entities[c],(b&a.mask)===b&&e.push(a);return e},remove:function(a){var b=this._entities.indexOf(a);return b>-1&&(this._entities.splice(b,1),this._director.events.emit("entity removed",a),a.destroy(!0)),this},removeAll:function(){for(var a,b=this._entities.length-1;b>-1;--b)a=this._entities.splice(b,1)[0],this._director.events.emit("entity removed",a),a.destroy(!0);return this},removeWithTag:function(a){for(var b,c=this._entities.length-1;c>-1;--c)this._entities[c].tag===a&&(b=this._entities.splice(c,1)[0],this._director.events.emit("entity removed",b),b.destroy(!0));return this},removeWithComponents:function(){for(var a,b=this._entities.length-1,c=A.apply(A,arguments);b>-1;--b)a=this._entities[b],(c&a.mask)===c&&(a=this._entities.splice(b,1)[0],this._director.events.emit("entity removed",a),a.destroy(!0));return this}});d.extend({EntityManager:I});var J=/.* event$/,K=d.Construct.extend("cog.SystemManager",{properties:{director:{get:function(){return this._director}},valid:{get:function(){return void 0!==this._director}}},init:function(a){this._director=a,this._eventContexts={},this._eventCallbacks={}},destroy:function(){this.unregisterAll(),this._director=void 0},emit:function(a){var c,d,e,f=this._eventContexts[a],g=this._eventCallbacks[a];if(f&&g)for(e=b.call(arguments,1),c=0,d=g.length;d>c;++c)g[c].apply(f[c],e);return this},register:function(a,b,c){if(!d.isObject(b)||!d.isFunction(c))return this;var e=this._eventContexts[a],f=this._eventCallbacks[a];return(void 0===e||void 0===f)&&(e=this._eventContexts[a]=[],f=this._eventCallbacks[a]=[]),e.push(b),f.push(c),this},registerContext:function(a){var b,c;for(b in a)(c=a[b])&&d.isFunction(c)&&J.test(b)&&this.register(b.substring(0,b.length-6),a,c);return this},unregister:function(a,b){var c,d=this._eventContexts[a],e=this._eventCallbacks[a];if(d&&e)for(c=d.length-1;c>=0;--c)d[c]===b&&(d.splice(c,1),e.splice(c,1));return this},unregisterContext:function(a){for(var b in this._eventContexts)this._eventContexts.hasOwnProperty(b)&&this.unregister(b,a);return this},unregisterEvent:function(a){var b=this._eventContexts[a],c=this._eventCallbacks[a];return b&&c&&(this._eventContexts[a].length=0,this._eventCallbacks[a].length=0),this},unregisterAll:function(){for(var a in this._eventContexts)this._eventContexts.hasOwnProperty(a)&&this.unregisterEvent(a);return this}});d.extend({EventManager:K});var L=d.Construct.extend("cog.SystemManager",{properties:{director:{get:function(){return this._director}},valid:{get:function(){return void 0!==this._director}}},init:function(a){this._systems={},this._systemOrder=[],this._director=a},destroy:function(){this.removeAll(),this._director=void 0},add:function(a){if(!a||!a.systemId)return void 0;var b=a.systemId,c=this._systems[b];return c||(c=new a(this),this._systems[b]=c,this._systemOrder.push(c),this._director.events.registerContext(c),c.configure(this._director.entities,this._director.events,this._director.config)),c},get:function(a){var b=a.systemId;return this._systems[b]},remove:function(a){var b,c,e;return a instanceof d.System&&(e=a,a=e.constructor),a&&a.systemId?(c=a.systemId,e||(e=this._systems[c]),e&&(b=this._systemOrder.indexOf(e),this._director.events.unregisterContext(e),this._systemOrder.splice(b,1),this._systems[c]=void 0,e.destroy(!0)),this):this},removeAll:function(){var a,b,c;for(b in this._systems)this._systems.hasOwnProperty(b)&&(c=this._systems[b],c&&(a=this._systemOrder.indexOf(c),this._director.events.unregisterContext(c),this._systemOrder.splice(a,1),this._systems[b]=void 0,c.destroy(!0)));return this},update:function(a){for(var b=0,c=this._systemOrder.length,d=this._systemOrder,e=this._director.entities,f=this._director.events;c>b;++b)d[b].update(e,f,a);return this},render:function(){for(var a=0,b=this._systemOrder.length,c=this._systemOrder,d=this._director.entities;b>a;++a)c[a].render(d);return this}});d.extend({SystemManager:L}),function(){for(var a=0,b=["webkit","moz"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var d=(new Date).getTime(),e=Math.max(0,16-(d-a)),f=window.setTimeout(function(){b(d+e)},e);return a=d+e,f}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)}),window.performance||(window.performance={now:function(){return Date().now()}})}();var M=d.Construct.extend("cog.Director",{create:function(a){return new M(a)}},{defaults:{_targetDt:1e3/60,_accumulator:0,_lastFrame:0},properties:{config:{get:function(){return this._config}},events:{get:function(){return this._eventManager}},entities:{get:function(){return this._entityManager}},systems:{get:function(){return this._systemManager}},valid:{get:function(){return void 0!==this._entityManager&&void 0!==this._systemManager&&void 0!==this._eventManager}}},init:function(a){this._config=a,this._eventManager=new K(this),this._entityManager=new I(this),this._systemManager=new L(this),this._beginUpdateCallback=null,this._animationFrame=null,this._fixedDt=a&&d.isBoolean(a.fixedDt)?a.fixedDt:!1},destroy:function(){this.stop(),this._entityManager.destroy(),this._eventManager.destroy(),this._systemManager.destroy(),this._entityManager=void 0,this._systemManager=void 0,this._eventManager=void 0,this._beginUpdateCallback=void 0,this._endUpdateCallback=void 0},start:function(){this._animationFrame||(this._lastFrame=performance.now(),this._animationFrame=requestAnimationFrame(this.step.bind(this)))},stop:function(){this._animationFrame&&(cancelAnimationFrame(this._animationFrame),this._animationFrame=null)},step:function(a){var b=this._targetDt,c=this._lastFrame,d=this._accumulator,e=a-c;if(this._beginStepCallback&&this._beginStepCallback(),this._fixedDt){d+=e;while(d>b)this.update(b),d-=b;this._accumulator=d}else this.update(e);this.render(),this._endStepCallback&&this._endStepCallback(),this._animationFrame&&(this._lastFrame=a,this._animationFrame=requestAnimationFrame(this.step.bind(this)))},update:function(a){this._beginUpdateCallback&&this._beginUpdateCallback(),this._systemManager.update(a),this._endUpdateCallback&&this._endUpdateCallback()},render:function(){this._systemManager.render()},onBeginUpdate:function(a){return this._beginUpdateCallback=a,this},onEndUpdate:function(a){return this._endUpdateCallback=a,this},onBeginStep:function(a){return this._beginStepCallback=a,this},onEndStep:function(a){return this._endStepCallback=a,this}});d.extend({Director:M,createDirector:M.create}),"function"==typeof define&&define.amd&&define("cog",[],function(){return d}),this.cog=d}).call(this);
//# sourceMappingURL=cog.min.map